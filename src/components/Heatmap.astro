---
import { getColorIntensity, getHeatmapData } from "../lib/heatmap";

const heatmapData = await getHeatmapData(100);
const maxWordCount = Math.max(...heatmapData.map((d) => d.wordCount));

// 将40天的数据分成4行，每行10个
const rows = 5;
const cols = 20;
const grid: typeof heatmapData = [];

for (let i = 0; i < rows * cols; i++) {
  grid.push(heatmapData[i] || { date: new Date(), wordCount: 0 });
}
---

<div class="heatmap-container relative space-y-2">
  <div class="grid gap-1.5" style="grid-template-columns: repeat(20, 1fr);">
    {
      grid.map((day, index) => {
        const colorClass = getColorIntensity(day.wordCount, maxWordCount);
        const dateStr = day.date.toLocaleDateString("zh-CN", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        return (
          <div
            class:list={["group relative aspect-square", colorClass]}
            data-date={dateStr}
            data-count={day.wordCount}
          >
            {day.wordCount > 0 && (
              <div class="tooltip absolute -top-10 left-1/2 z-10 hidden -translate-x-1/2 whitespace-nowrap bg-gray-900 px-2 py-1 text-xs text-white group-hover:block">
                <div class="font-medium">{dateStr}</div>
                <div>{day.wordCount} 字</div>
                <div class="absolute left-1/2 h-2 w-2 -translate-x-1/2 rotate-45 bg-gray-900" />
              </div>
            )}
          </div>
        );
      })
    }
  </div>
</div>

<style>
  .heatmap-cell:hover {
    transform: scale(1.1);
    z-index: 20;
  }

  .tooltip {
    animation: fadeIn 0.15s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translate(-50%, -4px);
    }
    to {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  }
</style>
