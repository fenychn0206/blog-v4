---
interface Props {
  pageKey: string;
  pageTitle: string;
}

const { pageKey, pageTitle } = Astro.props;
---

<hr />
<br />

<div class="text-sm text-zinc-500">
  <h6 class="">来过，就留下你的足迹吧！</h6>
</div>
<div id="artalk-comments"></div>

<script>
  import Artalk from "artalk";
  import "artalk/dist/Artalk.css";

  function initArtalk() {
    const container = document.getElementById("artalk-comments");
    if (!container) return;

    // 清理已有实例
    if ((window as any).artalkInstance) {
      (window as any).artalkInstance.destroy();
    }

    // 获取当前主题
    const isDark = document.documentElement.classList.contains("dark");

    // 创建 Artalk 实例
    (window as any).artalkInstance = Artalk.init({
      el: "#artalk-comments",
      pageKey: window.location.pathname,
      pageTitle: document.title,
      server: "https://artalk.ooowl.net", // 请替换为你的 Artalk 服务器地址
      site: "Blog", // 请替换为你的站点名称
      darkMode: isDark,
      locale: "zh-CN",
      emoticons: false,
      pagination: {
        pageSize: 10,
        readMore: true,
        autoLoad: true,
      },
      imgUpload: false,
      editorTravel: true,
    });
  }

  // 初始化评论系统
  initArtalk();

  // 监听主题切换
  const observer = new MutationObserver(() => {
    const isDark = document.documentElement.classList.contains("dark");
    if ((window as any).artalkInstance) {
      (window as any).artalkInstance.setDarkMode(isDark);
    }
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["class"],
  });

  // 支持 Astro 页面切换
  document.addEventListener("astro:after-swap", initArtalk);
  document.addEventListener("astro:page-load", initArtalk);
</script>

<style is:global>
  #artalk-comments {
    margin-top: 2rem;
  }

  /* 适配暗色模式 */
  .dark #artalk-comments {
    --at-color-bg: #18181b;
    --at-color-font: #e4e4e7;
    --at-color-border: #3f3f46;
    --at-color-meta: #a1a1aa;
  }

  /* 自定义样式 */
  .atk-comment-wrap {
    border-radius: 0.5rem;
  }

  .atk-main-editor {
    border-radius: 0.5rem;
  }
</style>
