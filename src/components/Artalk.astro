---
interface Props {
  pageKey: string;
  pageTitle: string;
}

const { pageKey, pageTitle } = Astro.props;
---

<div class="artalk-container">
  <p class="artalk-hint">来过，就留下你的足迹吧！</p>
  <div id="artalk-comments"></div>
</div>

<script>
  import Artalk from "artalk";
  import "artalk/dist/Artalk.css";

  function initArtalk() {
    const container = document.getElementById("artalk-comments");
    if (!container) return;

    // 检查当前页面路径是否与已初始化的实例路径相同
    const currentPath = window.location.pathname;
    if (
      (window as any).artalkInstance &&
      (window as any).artalkLastPath === currentPath
    ) {
      // 如果是同一页面，不需要重新初始化
      return;
    }

    // 清理已有实例
    if ((window as any).artalkInstance) {
      (window as any).artalkInstance.destroy();
    }

    // 获取当前主题
    const isDark = document.documentElement.classList.contains("dark");

    // 创建 Artalk 实例
    (window as any).artalkInstance = Artalk.init({
      el: "#artalk-comments",
      pageKey: currentPath,
      pageTitle: document.title,
      server: "https://artalk.ooowl.net", // 请替换为你的 Artalk 服务器地址
      site: "Frederick的博客", // 请替换为你的站点名称
      darkMode: isDark,
      locale: "zh-CN",
      emoticons: false,
      pagination: {
        pageSize: 10,
        readMore: true,
        autoLoad: true,
      },
      imgUpload: false,
      editorTravel: true,
    });

    // 记录当前页面路径
    (window as any).artalkLastPath = currentPath;
  }

  // 初始化评论系统
  initArtalk();

  // 监听主题切换
  const observer = new MutationObserver(() => {
    const isDark = document.documentElement.classList.contains("dark");
    if ((window as any).artalkInstance) {
      (window as any).artalkInstance.setDarkMode(isDark);
    }
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["class"],
  });

  // 支持 Astro 页面切换 - 只监听 after-swap 事件
  document.addEventListener("astro:after-swap", initArtalk);
</script>

<style is:global>
  .artalk-container {
    margin-top: 2rem;
  }

  .artalk-hint {
    font-size: 0.875rem;
    color: #71717a;
    margin-bottom: 0.75rem;
    text-align: center;
  }

  .dark .artalk-hint {
    color: #a1a1aa;
  }

  /* 适配暗色模式 */
  .dark #artalk-comments {
    --at-color-bg: #18181b;
    --at-color-font: #e4e4e7;
    --at-color-border: #3f3f46;
    --at-color-meta: #a1a1aa;
  }

  /* 自定义样式 */
  .atk-comment-wrap {
    border-radius: 0.5rem;
  }

  .atk-main-editor {
    border-radius: 0.5rem;
  }
</style>
