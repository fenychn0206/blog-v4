name: Astro 1Panel 自动部署

on:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  TZ: Asia/Shanghai

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 检查代码
        uses: actions/checkout@v4

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 安装依赖
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: 执行 Astro 构建
        run: npm run build

      - name: 部署静态产物到 deploy 分支
        run: |
          cd dist
          git init
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "Deploy: ${{ github.event.head_commit.message }} [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push --force --quiet "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" master:deploy

      - name: 服务器执行更新指令
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          port: ${{ secrets.PORT }}
          script: |
            SITE_DIR="/opt/1panel/www/sites/www.ooowl.net/index"
            REPO_SSH="git@github.com:${{ github.repository }}.git"
            
            cd $SITE_DIR
            git config --global --add safe.directory $SITE_DIR
            
            # 确保远程地址是最新的 SSH 地址
            if [ ! -d ".git" ]; then
              git init
              git remote add origin $REPO_SSH
            else
              git remote set-url origin $REPO_SSH
            fi
            
            # 强制同步
            git fetch origin deploy --depth=1
            git reset --hard origin/deploy
            git checkout -f deploy
            git clean -fd
            
            # 修正权限
            chown -R 1000:1000 $SITE_DIR
            
            echo "✅ 站点文件已成功布署至 $SITE_DIR"
