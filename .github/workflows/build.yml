name: Astro 1Panel 自动部署

on:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  TZ: Asia/Shanghai

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 检查代码
        uses: actions/checkout@v4

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 安装依赖
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: 执行 Astro 构建
        run: npm run build

      - name: 部署静态产物到 deploy 分支
        run: |
          cd dist
          git init
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "Deploy: ${{ github.event.head_commit.message }} [$(date +'%Y-%m-%d %H:%M:%S')]"
          # 强制推送到 deploy 分支
          git push --force --quiet "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" master:deploy

      - name: 服务器执行更新指令
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          port: ${{ secrets.PORT }}
          script: |
            SITE_DIR="/opt/1panel/www/sites/www.ooowl.net/index"
            # 确保目录存在
            mkdir -p $SITE_DIR
            cd $SITE_DIR
            
            # 1. 强制标记目录安全（防止 Git 权限报错）
            git config --global --add safe.directory $SITE_DIR
            
            # 2. 如果没有初始化 Git，则初始化并设置远程地址
            if [ ! -d ".git" ]; then
              git init
              git remote add origin https://github.com/${{ github.repository }}.git
            else
              # 确保远程地址始终是最新的
              git remote set-url origin https://github.com/${{ github.repository }}.git
            fi
            
            # 3. 核心步骤：抓取并同步文件
            # 获取远程的 deploy 分支，但不合并
            git fetch origin deploy --depth=1
            
            # 强制将当前目录的文件内容替换为远程 deploy 分支的内容
            git reset --hard origin/deploy
            
            # 清理可能存在的未跟踪文件（可选）
            git clean -fd
            
            # 4. 修正权限（重要：1Panel 的文件权限通常需要 www 权限）
            chown -R 1000:1000 $SITE_DIR
            
            echo "✅ 站点文件已成功解压到 $SITE_DIR"
